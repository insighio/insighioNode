<!DOCTYPE html>

<html>

    <head>
        <meta charset="UTF-8" />
        <title>insigh.io Device</title>
        <link rel="stylesheet" href="css/style.css" />
        <link rel="stylesheet" href="css/spectre-icons.min.css" />
        <link rel="stylesheet" href="css/spectre.min.css" />
    </head>

    <body class="body-custom">

        <img src="img/logo.png" class="img-responsive img-center">

        <div class="panel panel-custom">
          <div class="panel-header">
            <div class="panel-title text-center">Set active measurements</div>
          </div>

          <div class="panel-nav">
            <ul class="step">
              <li class="step-item"><a>Login</a></li>
              <li class="step-item"><a>Select Network</a></li>
              <li class="step-item"><a>Network Params</a></li>
              <li class="step-item"><a>API Keys</a></li>
              <li class="step-item active"><a>Measurements</a></li>
              <li class="step-item"><a>Timing</a></li>
              <li class="step-item"><a>Verify</a></li>
            </ul>
          </div>

          <div class="panel-body">
            <br />
            <hr />
            <br />
            <div id="loader" class="loading loading-lg"></div>
            <div class="empty">
              <p class="empty-title h5">Weight Scale Calibration</p>
              <p class="empty-subtitle">Offset: <span id="idle-weight-value" class="text-bold"><div id="loader4" class="loading" style="display: none"></div></span></p>
              <p class="empty-subtitle">Measured reference weight: <span id="measured-ref-weight-value" class="text-bold"><div id="loader1" class="loading"></div></span></p>
              <p class="empty-subtitle">Scale: <span id="scale-value" class="text-bold"><div id="loader2" class="loading"></div></span></p>
              <p class="empty-subtitle">Current Weight(g): <span id="scale-weight-value" class="text-bold"><div id="loader3" class="loading" style="display: none"></div></span></p>
              <div class="empty-action">
                <button class="btn btn-primary" id="recalibrate-button" style="margin-top: 5px" onclick="recalibrate()">Recalibrate</button>
                <button class="btn btn-primary" id="measure-button" style="margin-top: 5px" onclick="requestMeasure()">Measure</button>
                <button class="btn btn-primary" id="tare-button" style="margin-top: 5px" onclick="requestTare()">Tare</button>
                <button class="btn btn-primary" id="back-button" style="margin-top: 5px" onclick="goBack()">Back</button>
                <button class="btn btn-primary" id="save-button" style="margin-top: 5px" onclick="storeData()">Save</button>
              </div>
            </div>
          </div>
      </div>
      <script src="js/js.cookie.min.js"></script>
      <script src="js/utils.js"></script>
      <script>
        function initializeValues() {
          var offset = Cookies.get('meas-scale-offset')
          var scale = Cookies.get('meas-scale-scale')
  
          var offset = offset !== undefined ? parseFloat(offset) : undefined
          var scale = scale !== undefined ? parseFloat(scale) : undefined
  
          document.getElementById('idle-weight-value').innerHTML = offset
  
          if(offset === undefined || scale === undefined) {
            showElement('loader1', true)
            showElement('loader2', true)
            document.getElementById('save-button').disabled = true
            fetch("/raw-weight-idle?board=" + Cookies.get('selected-board')).then((response) => {
              return response.json();
            }).then(function(data) {
              var referenceExpectedWeight = parseFloat(Cookies.get('meas-scale-reference'))
              scale = (data.raw - offset) / referenceExpectedWeight
  
              document.getElementById('save-button').disabled = false
              document.getElementById('measured-ref-weight-value').innerHTML  = data.raw
              document.getElementById('scale-value').innerHTML = scale
              document.getElementById('scale-weight-value').innerHTML = referenceExpectedWeight
  
              showElement('loader1', false)
              showElement('loader2', false)
            }).catch((err) => {
              console.log("error completing request", err);
            });
          }
          else {
            showElement('loader1', false)
            showElement('loader2', false)
          }
  
          document.getElementById('scale-value').innerHTML = scale
  
          showElement('loader', false)
        }
  
        function clearCookies() {
          Cookies.remove('meas-scale-scale')
        }
  
        function recalibrate() {
          Cookies.remove('meas-scale-offset')
          Cookies.remove('meas-scale-scale')
          location.href = "step-5-1-scale-idle.html"
        }
  
        function storeData() {
          clearCookies()
          Cookies.set('meas-scale-scale', document.getElementById('scale-value').innerHTML)
          Cookies.set('meas-scale-offset', document.getElementById('idle-weight-value').innerHTML)
          location.href = "step-6-timing.html"
        }
  
        function requestTare() {
          showElement('loader4', true)
          document.getElementById('save-button').disabled = true
          fetch("/raw-weight?board=" + Cookies.get('selected-board')).then((response) => {
            return response.json();
          }).then(function(data) {
            document.getElementById('idle-weight-value').innerHTML = data.raw
            document.getElementById('scale-weight-value').innerHTML = 0
  
            document.getElementById('save-button').disabled = false
            showElement('loader4', false)
          }).catch((err) => {
            console.log("error setting tare", err);
  
            document.getElementById('save-button').disabled = false
            showElement('loader4', false)
          });
        }
  
        function requestMeasure() {
          showElement('loader3', true)
          document.getElementById('save-button').disabled = true
          fetch("/raw-weight?board=" + Cookies.get('selected-board')).then((response) => {
            return response.json();
          }).then(function(data) {
            const offset = parseFloat(document.getElementById('idle-weight-value').innerHTML)
            const scale = parseFloat(document.getElementById('scale-value').innerHTML)
            if(scale !== 0) {
              let weight = (data.raw - offset) / scale
              document.getElementById('scale-weight-value').innerHTML = Math.round(weight)
            }
            document.getElementById('save-button').disabled = false
            showElement('loader3', false)
          }).catch((err) => {
            console.log("error completing request", err);
            showElement('loader3', false)
            document.getElementById('save-button').disabled = false
          });
        }
  
        initializeValues()
      </script>
    </body>

</html>
