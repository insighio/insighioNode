<!DOCTYPE html>

<html>

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>insigh.io Device</title>
  <link rel="stylesheet" href="css/style.css" />
  <link rel="stylesheet" href="css/spectre.min.css" />
  <link rel="stylesheet" href="css/spectre-icons.min.css" />
</head>

<body class="body-custom">
  <img src="img/logo.png" class="img-responsive px-2 py-2 img-center">

  <div class="panel panel-custom">
    <div class="columns">
      <div class="panel-nav col-12 hide-sm"><br />
        <ul class="step">
          <li class="step-item"><a>Login</a></li>
          <li class="step-item"><a>Select Network</a></li>
          <li class="step-item"><a>Network Params</a></li>
          <li class="step-item"><a>API Keys</a></li>
          <li class="step-item active"><a>Measurements</a></li>
          <li class="step-item"><a>Timing</a></li>
          <li class="step-item"><a>Verify</a></li>
        </ul>
        <br />
        <hr />
      </div>
    </div>

    <div class="panel-body">
      <br />
      <div id="loader" class="loading loading-lg"></div>
      <div class="container grid-lg">
        <div class="columns flex-centered">
          <div class="column col-xl-7 col-md-10 col-sm-12">
            <div class="form-group">
              <div class="columns">
                <div class="col-12">
                  <div class="divider text-center" data-content="Custom measurement naming"></div>
                </div>
                <br />
                <div id="board-default-options" class="columns col-12" style="padding-right: 0px; padding-left: 0px">
                  <table class="table">
                    <thead>
                      <tr>
                        <th>name</th>
                        <th>alias</th>
                        <th>unit</th>
                        <th>value</th>
                      </tr>
                    </thead>
                    <tbody id="measurementList">
                    </tbody>
                  </table>
                </div>
                <br />
                <br />
              </div>
              <br />
              <div class="column col-12">
                <button class="btn btn-primary" type="button" id="update-measurements-button" onclick="executeMeasurements()">Update</button>
                <button class="btn btn-primary float-right" onClick="validateMyForm()" id="save-button" style="margin-left: 30px">Skip</button>
                <button class="btn btn-primary float-right" type="button" id="back-button" onclick="goBack()">Back</button>
              </div>
              <br />
              <br />
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>


  <script src="js/js.cookie.min.js"></script>
  <script src="js/utils.js"></script>
  <script>
    var shieldNamePerTab = {
      "shield-advind-options": "advind",
      "shield-scale-options": "scale",
      "shield-dig-analog-options": "dig_analog"
    }

    var storedMapping = undefined

    function initializeValues() {
      disableNavigationButtons()

      storedMapping = Cookies.get("meas-name-mapping")
      try{
        storedMapping = decodeURIComponent(storedMapping)
      }
      catch(e){
        console.log("failed decoding URI: ", storedMapping)
      }

      try {
        storedMapping = JSON.parse(storedMapping)
        console.log("successfully parsed name mappings")
      }
      catch (e) {
        console.log("failed parsing: ", storedMapping)
        storedMapping =  {}
      }

      if (storedMapping) {
        var editiedMapping = {}

        Object.keys(storedMapping).sort().forEach((measurement_name) => {
          editiedMapping[measurement_name] = {
            alias: storedMapping[measurement_name]
          }
        })
        populateTable(editiedMapping)
      }

      detectBoardChange(enableNavigationButtons)
    }

    function clearCookies() {

    }

    function storeData() {
      disableNavigationButtons()
      clearCookies();
      Cookies.set('meas-name-mapping', encodeURIComponent(JSON.stringify(getKeyValuePairs())))
      redirectTo("step-6-timing.html")
      enableNavigationButtons()
    }


    function validateMyForm() {
      storeData()
      return true
    }

    function skipOperation() {
      redirectTo("step-6-timing.html")
    }

    function addStaticValuesForNetwork(obj) {
      var net = Cookies.get('network')
      var netStats = Cookies.get('meas-network-stat')

      if (net === 'wifi' && netStats === "True") {
        obj["wifi_conn_duration"] = {}
        obj["wifi_scan_duration"] = {}
        obj["wifi_channel"] = {}
        obj["wifi_rssi"] = {}
      }
      else if (net === "cellular" && netStats === "True") {
        obj["cell_rssi"] = {}
        obj["cell_rsrp"] = {}
        obj["cell_rsrq"] = {}
        obj["cell_mcc"] = {}
        obj["cell_mnc"] = {}
        obj["cell_lac"] = {}
        obj["cell_ci"] = {}
        obj["cell_act_duration"] = {}
        obj["cell_att_duration"] = {}
        obj["cell_con_duration"] = {}
      }

      if (Cookies.get('meas-gps-enabled') === "True") {
        obj["gps_lat"] = {}
        obj["gps_lon"] = {}
        obj["gps_num_of_sat"] = {}
        obj["gps_hdop"] = {}
      }
    }

    function executeMeasurements() {
      showElement('loader', true)

      var config = Cookies.get()
      var configString = ""

      for (let key in config) {
        if (config.hasOwnProperty(key)) {
          configString += (key + "=" + config[key] + "&")
          if (key == 'wifi-ssid' || key == 'wifi-pass' || key == 'meas-keyvalue') {
            config[key] = decodeURIComponent(config[key]).replaceAll("\\", "\\\\").replaceAll("'", "\\'")
          }
        }
      }

      if (configString !== "")
        configString = configString.slice(0, -1)

      console.log("configString: ", configString)
      const objToSend = { queryParams: config, queryString: configString }

      if (configString == "") {
        startOver()
        return
      }

      fetch('/save-config-temp', {
        method: 'POST',
        headers: {
          'Accept': 'application/json, text/plain, */*',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(objToSend)
      }).then(res => {
        fetchInternal("/device_measurements")
          .then((measurements) => {
            addStaticValuesForNetwork(measurements)
            console.log("measurements: ", measurements)
            populateTable(measurements)

            updateFieldsWithMappingFromConfiguration()

            document.getElementById("save-button").innerText = "Save"

            showElement('loader', false)

          }).catch((err) => {
            showElement('loader', false)
            console.log("error fetching measurements: ", err)
          });
      })
        .catch(err => {
          console.log("error saving config: ", err)
        })
    }

    function populateTable(measurements) {
      var parent = document.getElementById("measurementList");
      parent.replaceChildren();

      var index = 0
      Object.keys(measurements).sort().forEach((measurement_name) => {
        var measurement = measurements[measurement_name]
        var row = document.createElement("tr")
        if (index % 2 === 0)
          row.classList.add('active')

        var colName = document.createElement("td")
        var colNameText = document.createElement("input")
        colNameText.id = 'input-key-name-' + index
        colNameText.value = measurement_name
        colNameText.readOnly = true
        colNameText.style = "border-width:0px;border:none; box-shadow: none; input:focus, textarea:focus, select:focus{outline: none;}"
        colName.appendChild(colNameText);

        var colAlias = document.createElement("td")
        var colAliasInput = document.createElement("input")
        colAliasInput.id = 'input-key-value-' + index
        if (measurement.alias)
          colAliasInput.value = measurement.alias
        colAlias.appendChild(colAliasInput);

        var colUnit = document.createElement("td")

        colUnit.appendChild(document.createTextNode(measurement.unit ? measurement.unit : ""));

        var colValue = document.createElement("td")
        colValue.appendChild(document.createTextNode(measurement.value !== undefined ? measurement.value : ""));

        row.appendChild(colName)
        row.appendChild(colAlias)
        row.appendChild(colUnit)
        row.appendChild(colValue)

        parent.appendChild(row)

        index++
      })
    }

    function updateFieldsWithMappingFromConfiguration() {
      var i = 0
      while (1) {
        var elemKey = document.getElementById("input-key-name-" + i);
        var elemValue = document.getElementById("input-key-value-" + i);

        if (!elemKey)
          break

        if (elemKey && elemKey.value !== '' && storedMapping[elemKey.value]) {
          elemValue.value = storedMapping[elemKey.value]
        }

        i++
      }
    }

    initializeValues()
  </script>
</body>

</html>
