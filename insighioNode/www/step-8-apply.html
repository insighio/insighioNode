<!DOCTYPE html>

<html>

    <head>
        <meta charset="UTF-8" />
        <title>insigh.io Device</title>
        <link rel="stylesheet" href="css/style.css" />
        <link rel="stylesheet" href="css/spectre-icons.min.css" />
        <link rel="stylesheet" href="css/spectre.min.css" />
    </head>

    <body class="body-custom">

        <img src="img/logo.png" class="img-responsive img-center">

        <div class="panel panel-custom">
          <div class="panel-header">
            <div class="panel-title text-center">Applying configuration</div>
          </div>

          <div class="panel-nav">
            <ul class="step">
              <li class="step-item"><a>Login</a></li>
              <li class="step-item"><a>Select Network</a></li>
              <li class="step-item"><a>Network Params</a></li>
              <li class="step-item"><a>API Keys</a></li>
              <li class="step-item"><a>Measurements</a></li>
              <li class="step-item"><a>Timing</a></li>
              <li class="step-item"><a>Verify</a></li>
            </ul>
          </div>

          <div class="panel-body">
            <br />
            <hr />
            <br />
            <div class="empty">
              <div class="empty-icon">
                <i class="icon icon-2x icon-check"></i>
              </div>
              <p class="empty-title h5">Configuration Applied</p>
              <p class="empty-subtitle">The device will soon reboot to the desired configuration.</p>
              <div class="empty-action">
                <button class="btn btn-primary" type="button" onclick="location.reload()">Re-apply Last Config</button>
                <button class="btn btn-primary" id="save-button" onclick="startOver()">Start over?</button>
              </div>
              <br />
              <br />
            </div>
          </div>
          <script>
            function startOver() {
              location.href = "step-2-select.html"
            }
            function apply(){
              const urlParams = new URLSearchParams(window.location.search);
  
              var queryComponents = window.location.search.substr(1, window.location.search.length - 1).split("&")
              const queryParamsDict = {}
              var queryStringCustom = ""
              queryComponents.forEach( component => {
                var compElems = component.split("=")
                var key = compElems[0]
                var value = compElems[1]
                if (key === "wifi-pass" || key === "wifi-ssid") {
                  try {
                    value = atob(value)
                  }catch(e) {
                  }
  
                  if(value.includes("'"))
                    value = value.replaceAll("'", "\\'")
                }
  
                var addSeparator = (queryStringCustom !== "")
                queryStringCustom += addSeparator ? "&" : ""
  
                queryStringCustom += key + "=" + value
  
                queryParamsDict[key] = value
              })
  
              console.log("queryStringCustom: ", queryStringCustom)
  
              const objToSend = {queryParams: queryParamsDict, queryString: queryStringCustom}
              console.log("obj: ", objToSend)
  
              fetch('/save-config', {
                method: 'POST',
                headers: {
                  'Accept': 'application/json, text/plain, */*',
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify(objToSend)
              }).then(res => res.json())
                .then(res => {
                    requestReboot()
                })
                .catch(err => {
                  console.log("error saving config: ", err)
                })
            }
  
            function requestReboot() {
              fetch('/reboot', {
                method: 'POST',
                headers: {
                  'Accept': 'application/json, text/plain, */*',
                  'Content-Type': 'application/json'
                },
                body: "{}"
              }).then(res => res.json())
                .then(res => console.log(res))
                .catch(err => {
                  console.log("error rebooting: ", err)
                })
            }
  
            apply()
          </script>
        </pre>
      </div>
    </body>

</html>
