<!DOCTYPE html>

<html>

{{ py }}

import gc
gc.collect()
from sensors import hx711
{{ end }}

    <head>
        <meta charset="UTF-8" />
        <title>insigh.io Device</title>
        <link rel="stylesheet" href="css/style.css" />
        <link rel="stylesheet" href="css/spectre-icons.min.css" />
        <link rel="stylesheet" href="css/spectre.min.css" />
    </head>

    <body class="body-custom">

        <img src="img/logo.png" class="img-responsive img-center">

        <div class="panel panel-custom">
          <div class="panel-header">
            <div class="panel-title text-center">Set active measurements</div>
          </div>

          <div class="panel-nav">
            <ul class="step">
              <li class="step-item"><a>Login</a></li>
              <li class="step-item"><a>Select Network</a></li>
              <li class="step-item"><a>Network Params</a></li>
              <li class="step-item"><a>API Keys</a></li>
              <li class="step-item active"><a>Measurements</a></li>
              <li class="step-item"><a>Timing</a></li>
              <li class="step-item"><a>Verify</a></li>
            </ul>
          </div>

          <div class="panel-body">
            <br />
            <hr />
            <br />
            <div id="loader" class="loading loading-lg"></div>
            <div class="empty">
              <p class="empty-title h5">Weight Scale Calibration</p>
              <p class="empty-subtitle">Offset: <span id="idle-weight-value" class="text-bold"></span></p>
              <p class="empty-subtitle">Measured reference weight: <span id="measured-ref-weight-value" class="text-bold">{{ hx711.get_reading(4, 33, 12, None, None, 25) }}</span></p>
              <p class="empty-subtitle">Scale: <span id="scale-value" class="text-bold"></span>.</p>
              <div class="empty-action">
                <button class="btn btn-primary" id="save-button" onclick="recalibrate()">Recalibrate</button>
                <button class="btn btn-primary" id="save-button" onclick="goBack()">Back</button>
                <button class="btn btn-primary" id="button-measure" onclick="storeData()">Save</button>
              </div>
            </div>
          </div>
      </div>
      <script src="js.cookie.min.js"></script>
      <script src="utils.js"></script>
      <script>
      function initializeValues() {
        var scale = {{ meas_scale_offset }}
        var offset = parseFloat(Cookies.get('meas-scale-offset'))

        document.getElementById('idle-weight-value').innerHTML = offset

        //if setting scale for the first time
        if(!scale) {
          var reference = {{ hx711.get_reading(4, 33, 12, None, None, 25) }}
          document.getElementById('measured-ref-weight-value').innerHTML = reference
          var referenceExpectedWeight = parseFloat(Cookies.get('meas-scale-reference'))

          console.log(offset, reference, referenceExpectedWeight)
          document.getElementById('scale-value').innerHTML = (reference - offset) / referenceExpectedWeight
        }
        else {
          document.getElementById('scale-value').innerHTML = scale
        }
        showElement('loader', false)
      }

      function clearCookies() {
        Cookies.remove('meas-scale-scale')
      }

      function recalibrate() {
        Cookies.remove('meas-scale-offset')
        Cookies.remove('meas-scale-scale')
        location.href = "step-5-1-scale-idle.html"
      }

      function storeData() {
        clearCookies()
        Cookies.set('meas-scale-scale', document.getElementById('scale-value').innerHTML)
        location.href = "step-6-timing.pyhtml"
      }

      initializeValues()
      </script>
    </body>

</html>
